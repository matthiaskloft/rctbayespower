---
title: "Getting Started with rctbayespower: Bayesian Power Analysis for RCTs"
date: "2025-07-22"
always_allow_html: true
---

# Algorithm Performance and Computational Considerations

This vignette provides guidance on algorithm selection, performance
optimization, and computational considerations when using the
`rctbayespower` package for Bayesian power analysis.

## Algorithm Overview

The `rctbayespower` package supports multiple algorithms with different
speed-accuracy trade-offs:

**Recommended workflow:** 1. **Exploration**: `meanfield` for faster
roundtrip 2. **Refinement**: `fullrank` as an alternative to `meanfield`
for more accuracy, however might not converge 3. **Confirmation**:
`sampling` for final results

# Performance Comparison

## Setup

### Model

``` r
model_file <- here::here("test_model_ancova.rds")
if (file.exists(model_file)) {
  # load the model from a file
  model_ancova <- readRDS(model_file)
} else{
  # create the model
  model_ancova <- build_model_ancova_cont()
  # save the model to a file
  saveRDS(model_ancova, file = model_file)
}
model_ancova$parameter_names_brms
#> [1] "b_Intercept" "b_covariate" "b_arm2"
```

### Design

``` r
design <- build_design(
  model = model_ancova,
  target_params = "b_arm2",
  thresholds_success = 0.1,
  thresholds_futility = 0,
  p_sig_success = 0.975,
  p_sig_futility = 0.5
)
# check the required parameters for the design
required_fn_args(design)
#> 
#> Arguments that need user specification.
#> 
#> Simulation function:
#> n_total, b_arms_treat, b_covariate 
#> 
#> Interim function:
#> 
```

### Conditions

``` r
conditions <- build_conditions(
  design = design,
  condition_values = list(
    # two sample sizes
    n_total = 400,
      # two effect sizes
    b_arms_treat = c(0,0.3)
  ),
  static_values = list(
    # equal allocation
    p_alloc = c(0.5, 0.5),
          # baseline effect
    b_covariate = 0
  )
)
print(conditions, n = 100)
#> 
#> Object of class: 'rctbayespower_conditions'
#> --------------------------------------------------
#> 
#> Number of conditions: 2 
#> Number of varying parameters: 3 
#> 
#> Condition Grid:
#> # A tibble: 2 Ã— 3
#>   id_cond n_total b_arms_treat
#>     <int>   <dbl>        <dbl>
#> 1       1     400          0  
#> 2       2     400          0.3
```

## Run Simulations for Comparison

``` r
n_cores <- parallel::detectCores() - 2
n_sims <- 1000

# Meanfield
suppressWarnings(
  power_result_meanfield <-
    power_analysis(
      conditions = conditions,
      n_cores = n_cores,
      n_simulations = n_sims,
      verbose = FALSE,
      brms_args = list(
        algorithm = "meanfield",
        importance_resampling = TRUE,
        iter = 1e4,
        output_samples = 2e3
      )
    )
)
# Fullrank
suppressWarnings(
  power_result_fullrank <-
    power_analysis(
      conditions = conditions,
      n_cores = n_cores,
      n_simulations = n_sims,
      verbose = FALSE,
      brms_args = list(
        algorithm = "fullrank",
        importance_resampling = TRUE,
        iter = 1e4,
        output_samples = 2e3
      )
    )
)
# Sampling
power_result_sampling <- power_analysis(
  conditions = conditions,
  n_cores = n_cores,
  n_simulations = n_sims,
  verbose = FALSE,
  brms_args = list(
    chains = 4,
    iter = 700,
    warmup = 200
  )
)

results_summary<- rbind(
  power_result_meanfield$results_df |> 
    mutate(Algorithm = "Meanfield"),
  power_result_fullrank$results_df |> 
    mutate(Algorithm = "Fullrank"),
  power_result_sampling$results_df |> 
    mutate(Algorithm = "Sampling")
)
```

Power

``` r
results_summary |> 
  select(
    Algorithm,
    n_total,
    b_arms_treat,
    success_prob,
    success_power,
    futility_prob,
    futility_power
  ) |>
  kableExtra::kable(digits = 2)
```

| Algorithm | n_total | b_arms_treat | success_prob | success_power | futility_prob | futility_power |
|:---|---:|---:|---:|---:|---:|---:|
| Meanfield | 400 | 0.0 | 0.24 | 0.00 | 0.51 | 0.51 |
| Meanfield | 400 | 0.3 | 0.92 | 0.52 | 0.02 | 0.00 |
| Fullrank | 400 | 0.0 | 0.24 | 0.00 | 0.49 | 0.48 |
| Fullrank | 400 | 0.3 | 0.92 | 0.52 | 0.02 | 0.00 |
| Sampling | 400 | 0.0 | 0.23 | 0.00 | 0.50 | 0.50 |
| Sampling | 400 | 0.3 | 0.92 | 0.52 | 0.02 | 0.00 |

Convergence

``` r
results_summary |> 
  select(
    Algorithm,
    n_total,
    b_arms_treat,
    rhat,
    ess_bulk,
    ess_tail
  ) |>
  kableExtra::kable(digits = 3)
```

| Algorithm | n_total | b_arms_treat |  rhat | ess_bulk | ess_tail |
|:----------|--------:|-------------:|------:|---------:|---------:|
| Meanfield |     400 |          0.0 | 1.027 |  495.521 |  428.192 |
| Meanfield |     400 |          0.3 | 1.013 |  494.958 |  436.324 |
| Fullrank  |     400 |          0.0 | 1.010 |  725.346 |  643.813 |
| Fullrank  |     400 |          0.3 | 1.009 |  714.380 |  640.886 |
| Sampling  |     400 |          0.0 | 1.002 | 2036.894 | 1471.060 |
| Sampling  |     400 |          0.3 | 1.002 | 2036.175 | 1471.069 |

Compare run times for each algorithm:

``` r
# extract elapsed time
data.frame(
  Alorithm = c(
    "Meanfield",
    "Fullrank",
    "Sampling"
  ),
    "Elapsed Time" = c(
      power_result_meanfield$elapsed_time,
      power_result_fullrank$elapsed_time,
      power_result_sampling$elapsed_time
    )
  ) |> 
  kableExtra::kable(digits = 2)
```

| Alorithm  | Elapsed.Time |
|:----------|:-------------|
| Meanfield | 2.24 mins    |
| Fullrank  | 2.21 mins    |
| Sampling  | 2.21 mins    |

------------------------------------------------------------------------

# Session Information

``` r
sessionInfo()
#> R version 4.5.0 (2025-04-11 ucrt)
#> Platform: x86_64-w64-mingw32/x64
#> Running under: Windows 11 x64 (build 26100)
#> 
#> Matrix products: default
#>   LAPACK version 3.12.1
#> 
#> locale:
#> [1] LC_COLLATE=German_Germany.utf8  LC_CTYPE=German_Germany.utf8   
#> [3] LC_MONETARY=German_Germany.utf8 LC_NUMERIC=C                   
#> [5] LC_TIME=German_Germany.utf8    
#> 
#> time zone: Europe/Berlin
#> tzcode source: internal
#> 
#> attached base packages:
#> [1] stats     graphics  grDevices utils     datasets  methods   base     
#> 
#> other attached packages:
#>  [1] rctbayespower_0.1.0 testthat_3.2.3      devtools_2.4.5     
#>  [4] usethis_3.1.0       lubridate_1.9.4     forcats_1.0.0      
#>  [7] stringr_1.5.1       dplyr_1.1.4         purrr_1.0.4        
#> [10] readr_2.1.5         tidyr_1.3.1         tibble_3.3.0       
#> [13] ggplot2_3.5.2       tidyverse_2.0.0     here_1.0.1         
#> [16] rmarkdown_2.29     
#> 
#> loaded via a namespace (and not attached):
#>  [1] gridExtra_2.3        remotes_2.5.0        inline_0.3.21       
#>  [4] rlang_1.1.6          magrittr_2.0.3       matrixStats_1.5.0   
#>  [7] compiler_4.5.0       loo_2.8.0            systemfonts_1.2.3   
#> [10] vctrs_0.6.5          profvis_0.4.0        pkgconfig_2.0.3     
#> [13] fastmap_1.2.0        backports_1.5.0      ellipsis_0.3.2      
#> [16] promises_1.3.3       sessioninfo_1.2.3    tzdb_0.5.0          
#> [19] xfun_0.52            cachem_1.1.0         later_1.4.2         
#> [22] parallel_4.5.0       R6_2.6.1             stringi_1.8.7       
#> [25] RColorBrewer_1.1-3   StanHeaders_2.32.10  pkgload_1.4.0       
#> [28] brio_1.1.5           Rcpp_1.0.14          rstan_2.32.7        
#> [31] knitr_1.50           bayesplot_1.13.0     httpuv_1.6.16       
#> [34] Matrix_1.7-3         timechange_0.3.0     tidyselect_1.2.1    
#> [37] rstudioapi_0.17.1    abind_1.4-8          yaml_2.3.10         
#> [40] codetools_0.2-20     miniUI_0.1.2         pkgbuild_1.4.8      
#> [43] lattice_0.22-7       shiny_1.11.0         withr_3.0.2         
#> [46] bridgesampling_1.1-2 posterior_1.6.1      coda_0.19-4.1       
#> [49] evaluate_1.0.4       desc_1.4.3           RcppParallel_5.1.10 
#> [52] urlchecker_1.0.1     xml2_1.3.8           pillar_1.11.0       
#> [55] tensorA_0.36.2.1     checkmate_2.3.2      stats4_4.5.0        
#> [58] distributional_0.5.0 generics_0.1.4       rprojroot_2.0.4     
#> [61] hms_1.1.3            rstantools_2.4.0     scales_1.4.0        
#> [64] xtable_1.8-4         glue_1.8.0           tools_4.5.0         
#> [67] fs_1.6.6             mvtnorm_1.3-3        grid_4.5.0          
#> [70] QuickJSR_1.8.0       colorspace_2.1-1     nlme_3.1-168        
#> [73] cli_3.6.5            kableExtra_1.4.0     textshaping_1.0.1   
#> [76] viridisLite_0.4.2    svglite_2.2.1        Brobdingnag_1.2-9   
#> [79] gtable_0.3.6         digest_0.6.37        brms_2.22.0         
#> [82] htmlwidgets_1.6.4    farver_2.1.2         memoise_2.0.1       
#> [85] htmltools_0.5.8.1    lifecycle_1.0.4      mime_0.13
```
