---
title: "Getting Started with rctbayespower: Bayesian Power Analysis for RCTs"
date: "`r Sys.Date()`"
always_allow_html: true
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "/man/figures/01-introduction-",
  out.width = "90%",
  fig.width = 10,
  fig.height = 7,
  message = FALSE
)

# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Check and install required packages
packages <- c("tidyverse", "devtools")
install.packages(setdiff(packages, rownames(installed.packages())))
invisible(lapply(packages, require, character.only = TRUE))

# load the package
devtools::load_all(".")
```

# Introduction

The `rctbayespower` package provides tools for conducting Bayesian power analysis for randomized controlled trials (RCTs) using the `brms` package and Stan. Unlike traditional frequentist power analysis, Bayesian power analysis allows researchers to:

- Incorporate prior knowledge about treatment effects
- Use probabilistic statements about effect sizes
- Consider regions of practical equivalence (ROPE)
- Account for uncertainty in parameter estimates

This vignette demonstrates the main functions of the package with practical examples using real model fitting.


# Basic Power Analysis Using ANCOVA Design



### Model

```{r}
model_file <- here::here("test_model_ancova.rds")
if (file.exists(model_file)) {
  # load the model from a file
  model_ancova <- readRDS(model_file)
} else{
  # create the model
  model_ancova <- build_model(pre_defined_model = "ancova_cont_2arms")
  # save the model to a file
  saveRDS(model_ancova, file = model_file)
}
print(model_ancova)
```

### Design

Find possible target parameters in the model.
```{r}
attr(model_ancova, "parameter_names_brms")
```

Specify the study design with target parameter, thresholds for success and futility, and significance levels for frequentist-like power.
```{r}
design <- build_design(
  model = model_ancova,
  target_params = "b_arm2",
  thresholds_success = 0.1,
  thresholds_futility = 0,
  p_sig_success = 0.975,
  p_sig_futility = 0.5
)
print(design)
```


### Conditions

Find parameters that need user specification for the design.
```{r}
required_fn_args(design)
```

Specify conditions.
```{r}
conditions <- build_conditions(
  design = design,
  condition_values = list(
    # two sample sizes
    n_total = 300,
        # two effect sizes
    b_arms_treat = c(0,0.3)
  ),
  static_values = list(
    # equal allocation
    p_alloc =
      list(c(0.5, 0.5)),
          # baseline effect
    b_covariate = 0
  )
)
print(conditions, n = 100)
```


## Run Power Analysis
Set number of cores and simulations. The number of simulations is set to a lower value for faster vignette building, but you can increase it for more robust results.
```{r}
n_cores <- parallel::detectCores() - 2
n_sims <- n_cores * 30
```

```{r basic_performance}
power_results <- power_analysis(
  conditions = conditions,
  n_cores = n_cores,
  n_simulations = n_sims,
  verbose = FALSE,
  brms_args = list(
    chains = 4,
    iter = 700,
    warmup = 200
  )
)

power_results$results_df
```



***


# Session Information

```{r session_info}
sessionInfo()
```
