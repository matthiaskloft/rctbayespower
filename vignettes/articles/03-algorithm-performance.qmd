---
title: "Comparative Algorithm Performance in 'rctbayespower'"
author: 
 - name: Matthias Kloft
   orcid: 0000-0003-1845-6957
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    fig-width: 7
    fig-height: 4.5
    embed-resources: true
execute:
  message: false
  warning: false
---

Setup:
```{r setup}
# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Check and install required packages
packages <- c("dplyr", "kableExtra", "pander")
install.packages(setdiff(packages, rownames(installed.packages())))
invisible(lapply(packages, require, character.only = TRUE))

# Load the package
library(rctbayespower)

# Set number of cores and simulations:
n_cores <- parallel::detectCores() - 2
n_sims <- 500
```

***

# Algorithm Performance and Computational Considerations

This vignette provides guidance on algorithm selection, performance optimization, and computational considerations when using the `rctbayespower` package for Bayesian power analysis.


## Algorithm Overview

The `rctbayespower` package supports multiple algorithms via `brms` / `Stan`:

- `meanfield` (variational inference)
- `fullrank`  (variational inference)
- `sampling` (MCMC)



# Performance Comparison

## Setup
### Model

Show predefined models available in the package:
```{r}
show_predefined_models()
```


Build a design using the predefined ANCOVA model for continuous outcomes with two arms:
```{r build_design}
# Build design with predefined model (model merged into design)
design <- build_design(
  model_name = "ancova_cont_2arms",
  target_params = "b_arm2"
)
# Check available parameter names
design@par_names_inference
# Check the required parameters for conditions
show_condition_args(design)
```


### Conditions

```{r build_conditions}
conditions <- build_conditions(
  design = design,
  crossed = list(
    # sample size
    n_total = 400,
    # two effect sizes
    b_arm_treat = c(0, 0.3)
  ),
  constant = list(
    # equal allocation
    p_alloc = c(0.5, 0.5),
    # baseline effect
    b_covariate = 0,
    # decision thresholds
    thr_dec_eff = 0.975,
    thr_dec_fut = 0.5,
    thr_fx_eff = 0.1,
    thr_fx_fut = 0
  )
)
```


## Run Simulations

```{r run_power_analyses}
# Meanfield
  power_result_meanfield <-
    power_analysis(
      conditions = conditions,
      n_cores = n_cores,
      n_sims = n_sims,
      verbosity = 0,
      brms_args = list(
        algorithm = "meanfield",
        importance_resampling = TRUE,
        iter = 1e4,
        output_samples = 2e3
      )
    )

# Fullrank
  power_result_fullrank <-
    power_analysis(
      conditions = conditions,
      n_cores = n_cores,
      n_sims = n_sims,
      verbosity = 0,
      brms_args = list(
        algorithm = "fullrank",
        importance_resampling = TRUE,
        iter = 1e4,
        output_samples = 2e3
      )
    )

# Sampling
power_result_sampling <- power_analysis(
  conditions = conditions,
  n_cores = n_cores,
  n_sims = n_sims,
  verbose = FALSE,
  brms_args = list(
    chains = 4,
    iter = 700,
    warmup = 200
  )
)
```


Extract the summarized results from each power analysis:
```{r}
results_summary<- rbind(
  power_result_meanfield@results_summ |> 
    mutate(Algorithm = "Meanfield"),
  power_result_fullrank@results_summ |> 
    mutate(Algorithm = "Fullrank"),
  power_result_sampling@results_summ |> 
    mutate(Algorithm = "Sampling")
)
```

## Comparison of Results

### Probability of Success and Futility and Power
```{r}
results_summary |> 
  select(
    Algorithm,
    n_total,
    b_arm_treat,
    pr_eff,
    pr_fut,
    pwr_eff,
    pwr_fut
  ) |>
  dplyr::arrange(desc(b_arm_treat)) |> 
  kableExtra::kable(digits = 2)
```


### Convergence
```{r}
results_summary |> 
  select(
    Algorithm,
    n_total,
    b_arm_treat,
    rhat,
    ess_bulk,
    ess_tail,
    conv_rate
  ) |>
  kableExtra::kable(digits = 3)
```


### Run Time
```{r}
# extract elapsed time
data.frame(
  Alorithm = c(
    "Meanfield",
    "Fullrank",
    "Sampling"
  ),
    "Elapsed Time" = c(
      power_result_meanfield@elapsed_time,
      power_result_fullrank@elapsed_time,
      power_result_sampling@elapsed_time
    )
  ) |> 
  kableExtra::kable(digits = 2)
```


***


# Session Information

```{r session_info}
pander::pander(sessionInfo())
```
