---
title: "Getting Started with 'rctbayespower'"
author: 
 - name: Matthias Kloft
   orcid: 0000-0003-1845-6957
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    number-sections: true
    theme: cosmo
    code-fold: false
    code-tools: true
    code-summary: "Show the code"
    fig-width: 7
    fig-height: 4.5
    embed-resources: true
execute:
  message: false
  warning: false
---

Setup:
```{r setup}
#| message: false

# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Check and install required packages
packages <- c("dplyr", "kableExtra", "pander")
install.packages(setdiff(packages, rownames(installed.packages())))
invisible(lapply(packages, require, character.only = TRUE))
library(rctbayespower)


# Set number of cores and simulations:
n_cores <- parallel::detectCores() - 2
n_sims <- 500
```

***

# Introduction

The `rctbayespower` package provides tools for conducting Bayesian power analysis for randomized controlled trials (RCTs) using the `brms` package and Stan. 



# Basic Power Analysis Using ANCOVA Design



## Design

Show predefined models available in the package:
```{r}
show_predefined_models()
show_target_params("ancova_cont_2arms")
```


Build a design using a predefined ANCOVA model for continuous outcomes with two arms:
```{r build_design}
# Build design with predefined model (model is now merged into design)
design <- build_design(
  model_name = "ancova_cont_2arms",
  target_params = "b_arm2"
)
print(design)
```


### Conditions

Find parameters that need user specification for the design.
```{r}
show_condition_args(design)
```
```{r}
show_boundaries()
```


Specify conditions.
```{r build_conditions}
conditions <- build_conditions(
  design = design,
  crossed = list(
    # two sample sizes
    link(
    n_total = seq(80, 160, by = 80),
    analysis_at = list(c(40, 80),c(30,160))
    ),
    # link thresholds to effect sizes
    link(
      # two effect sizes
      b_arm_treat = c(0, 0.3),
      # corresponding thresholds for success and futility
      thr_dec_eff = c(0.95, boundary_pocock(alpha = .05)),
      thr_dec_fut = c(0.5, boundary_pocock(alpha = .5))
    )
  ),
  constant = list(
    # baseline effect
    b_covariate = 0,
    thr_fx_eff = 0.1,
    thr_fx_fut = 0
  )
)
print(conditions, n = 100)
conditions@params_by_cond
conditions@grid
```

## Run Power Analysis

Run the analysis using the `power_analysis` function. This will run the model for each condition and return the results.
```{r run_sim}
power <- power_analysis(
  conditions = conditions,
  n_cores = n_cores,
  n_sims = 10,
  verbosity = 2,
  brms_args = list(
    chains = 1,
    iter = 300,
    warmup = 100
  )
)
```

```{r}
print(power)
```

```{r}
summary(power)
```

```{r}
report(x = power, topic = c("power", "stopping", "stopping_by_look"), format = "cli", heading_level = 3)
```

```{r}
report_conditions(x = power)
```

```{r}
report_early_stopping(x = power, format = "markdown", heading_level = 3)
```


```{r}
plot(
  power,
  type = "power_curve",
  facet_by = "metric",
  show_target = FALSE,
  values = "post_prob",
  show_mcse = TRUE, 
  interactive = FALSE
)
```


```{r}
res <- power@results_interim
power2 <- resummarize_boundaries(power, thr_dec_fut = boundary_obf(), thr_dec_eff = boundary_obf())
res2 <- power2@results_interim
```

```{r}
plot(res2)
```


## Power for Effect of 0.3
```{r power_success}
power@results_summ |>
  dplyr::filter(b_arm_treat != 0) |>
  select(
    n_total,
    b_arm_treat,
    pr_eff,
    se_pr_eff,
    pwr_eff,
    se_pwr_eff,
    pr_fut,
    se_pr_fut,
    pwr_fut,
    se_pwr_fut
  ) |>
  dplyr::arrange(desc(b_arm_treat)) |>
  kableExtra::kable(digits = 3, format = "html")
```


## Alpha Error Rate for Null Effect 

The power for success indicates the alpha error rate for the null effect (b_arm_treat = 0). This is the probability of rejecting the null hypothesis when it is true, which should be close to the significance level (0.05) if the design is well specified.

```{r power_null}
power@results_summ |>
  dplyr::filter(b_arm_treat == 0) |>
  select(
    n_total,
    b_arm_treat,
    pr_eff,
    se_pr_eff,
    pwr_eff,
    se_pwr_eff,
    pwr_fut,
    se_pwr_fut,
    pr_fut,
    se_pr_fut
  ) |>
  dplyr::arrange(desc(b_arm_treat)) |> 
  kableExtra::kable(digits = 3, 
                    format = "html")
```

## Run Time

```{r}
#| code-fold: true


n_runs <- nrow(power@conditions@grid) * power@n_sims
cat("Total run time:", round(power@elapsed_time,1), "minutes for", n_runs, "total simulation repetitions using", power@n_cores, "cores.\n")
```

***


# Session Information

```{r session_info}
pander::pander(sessionInfo())
```
