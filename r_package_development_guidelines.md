# R Package Development Best Practices for Claude Code

## 1. Package Structure and Organization

### Required Components
- **R/** directory: Contains all R code files (.R extension)
- **DESCRIPTION** file: Package metadata (no extension)
- **NAMESPACE** file: Declares exports and imports
- **man/** directory: Documentation files (auto-generated by roxygen2)
- **tests/** directory: Test files using testthat

### Optional Components
- **data/** directory: Package data files
- **inst/** directory: Additional files installed with package
- **vignettes/** directory: Long-form documentation
- **src/** directory: C/C++ source code
- **.Rbuildignore**: Files to exclude from package build
- **.gitignore**: Files to exclude from version control

## 2. DESCRIPTION File Requirements

### Essential Fields
```
Package: packagename
Title: What the Package Does (One Line, Title Case, No Period)
Version: 0.0.0.9000
Authors@R: person("First", "Last", email = "email@example.com",
                  role = c("aut", "cre"))
Description: A paragraph describing what the package does. Each line
    must be no more than 80 characters wide. Indent subsequent lines
    with 4 spaces.
License: MIT + file LICENSE
Encoding: UTF-8
LazyData: true
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.2.1
```

### Dependency Fields
- **Imports**: Packages your code needs to work
- **Suggests**: Packages for development/optional features
- **Depends**: Use sparingly (R version or when namespace attachment needed)
- **LinkingTo**: For C/C++ dependencies

### Best Practices
- One package per line in dependency lists
- Alphabetical order
- Use `usethis::use_package()` to add dependencies
- Specify minimum versions when using new features
- Package names in single quotes in Title/Description

## 3. Dependency Management

### Using Dependencies in Code
- **In R/ files**: Use `pkg::function()` for Imports packages
- **Never use** `library()` or `require()` in package code
- **Import specific functions**: Use roxygen2 `@importFrom pkg function`
- **Import entire namespace** (rare): Use `@import pkg`

### Dependency Best Practices
- Minimize dependencies - each has a cost
- Prefer Imports over Depends
- Use Suggests for optional features
- Check dependencies are truly needed with `pak::pkg_deps_explain()`

## 4. Code Organization

### File Naming
- Use descriptive names: `fit-model.R`, `utils-string.R`
- Group related functions in same file
- One file per major function/feature area
- Helper functions can share files

### Function Requirements
- All functions must be in R/ directory
- No code at top level (outside functions)
- Use `.onLoad()` for package initialization (rare)
- Internal functions: don't export, consider `@noRd`

### Code Style
- Follow tidyverse style guide
- Use `styler::style_pkg()` for consistent formatting
- Avoid `T`/`F`, use `TRUE`/`FALSE`
- Use `<-` for assignment, not `=`

## 5. Documentation Standards

### Roxygen2 Setup
- Add `Roxygen: list(markdown = TRUE)` to DESCRIPTION
- Use `devtools::document()` to generate documentation
- Never edit files in man/ directly

### Function Documentation Template
```r
#' Title in Sentence Case
#'
#' Description of what the function does. Can be multiple
#' sentences.
#'
#' More details about the function if needed.
#'
#' @param x Description of parameter x
#' @param y Description of parameter y
#' @return Description of return value
#' @export
#' @examples
#' function_name(1, 2)
#'
#' \donttest{
#' # Examples that shouldn't run during checks
#' slow_function()
#' }
function_name <- function(x, y) {
  # function body
}
```

### Documentation Requirements
- Title: One line, no period, sentence case
- Description: Brief overview
- Document all parameters with `@param`
- Document return value with `@return`
- Include runnable examples
- Export user-facing functions with `@export`

## 6. Testing Practices

### Test Setup
- Use `usethis::use_testthat()` to initialize
- Tests go in `tests/testthat/test-*.R` files
- One test file per R source file recommended

### Test Structure
```r
test_that("function_name works", {
  expect_equal(function_name(2, 3), 5)
  expect_error(function_name("a", "b"), "error message")
})
```

### Testing Guidelines
- Test external interface, not internals
- One behavior per test
- Use helper functions for test setup
- Skip tests conditionally with `skip_on_cran()`, `skip_if_not_installed()`
- Aim for high test coverage
- Tests must run in < 1 minute total for CRAN

## 7. R CMD check Requirements

### Must Pass With Zero Issues
- **0 ERRORs**: Fix all errors
- **0 WARNINGs**: Fix all warnings
- **0 NOTEs**: Fix notes when possible

### Common Check Issues
- Undocumented functions/parameters
- Missing or incorrect examples
- Non-standard file names
- Large file sizes
- Non-portable file paths
- Missing dependencies

### Development Workflow
1. Edit code
2. `devtools::document()` - update documentation
3. `devtools::test()` - run tests
4. `devtools::check()` - full R CMD check
5. Fix issues and repeat

## 8. Development Best Practices

### Core Workflow Functions
- `usethis::create_package()` - create new package
- `devtools::load_all()` - load package for testing (Cmd/Ctrl+Shift+L)
- `devtools::document()` - generate documentation (Cmd/Ctrl+Shift+D)
- `devtools::test()` - run tests (Cmd/Ctrl+Shift+T)
- `devtools::check()` - run R CMD check (Cmd/Ctrl+Shift+E)
- `devtools::install()` - install package locally

### File Path Handling
- Never use `setwd()` in package code
- Use `system.file()` for package files
- Use `testthat::test_path()` in tests
- Always use relative paths
- Consider `fs` package for robust path handling

### Working Directory
- Never change working directory
- Assume working directory is package root
- Use proper path helpers for subdirectories

## 9. CRAN Submission Guidelines

### Pre-submission Checklist
- Run `devtools::check()` with 0 issues
- Check on multiple platforms with `rhub::check()`
- Update NEWS.md with version changes
- Check reverse dependencies if applicable
- Verify all examples run in < 5 seconds
- Ensure total check time < 10 minutes

### CRAN Policies
- Maintain package (fix issues promptly)
- Examples must run without errors
- Don't write to user's file system
- Respect user's options/settings
- Include proper citations
- License must be CRAN-compatible

### Version Numbering
- Development: 0.0.0.9000
- First release: 0.1.0
- Patches: 0.1.1, 0.1.2
- Minor releases: 0.2.0
- Major releases: 1.0.0

## 10. Additional Best Practices

### Version Control
- Use Git for all packages
- `.gitignore` should include:
  - .Rproj.user
  - .Rhistory
  - .RData
  - .Ruserdata
  - src/*.o
  - src/*.so
  - src/*.dll

### Continuous Integration
- Use GitHub Actions for automated checking
- Test on multiple R versions
- Test on multiple operating systems
- Run with `NOT_CRAN=true` for full tests

### Performance Considerations
- Profile slow code with `profvis`
- Consider C++ via Rcpp for bottlenecks
- Lazy load data with `LazyData: true`
- Minimize package startup time

### User Experience
- Clear error messages with `cli` or `rlang`
- Progress bars for long operations
- Interruptible C/C++ code
- Informative warnings and messages

## Key Commands Reference

```r
# Package creation
usethis::create_package("path/to/package")

# Add dependencies
usethis::use_package("dplyr", type = "Imports")
usethis::use_package("testthat", type = "Suggests")

# Development cycle
devtools::load_all()     # Cmd/Ctrl + Shift + L
devtools::document()     # Cmd/Ctrl + Shift + D
devtools::test()        # Cmd/Ctrl + Shift + T
devtools::check()       # Cmd/Ctrl + Shift + E

# Documentation
usethis::use_readme_rmd()
usethis::use_news_md()
usethis::use_vignette("intro")

# Testing
usethis::use_testthat()
usethis::use_test("function-name")

# Git/GitHub
usethis::use_git()
usethis::use_github()
```

## Summary

Claude Code should prioritize:
1. Clean package structure following R conventions
2. Comprehensive documentation with roxygen2
3. Thorough testing with testthat
4. Passing R CMD check with zero issues
5. Minimal, well-justified dependencies
6. Clear code organization and style
7. Proper version control with Git
8. Continuous integration for quality assurance
9. Following CRAN policies for sustainability
10. Excellent user experience with helpful errors and documentation
